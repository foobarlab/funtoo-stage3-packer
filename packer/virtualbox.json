{
  "min_packer_version": "1.6.3",
  "builders": [{
      "boot_command": [
        "<enter>","<wait>",
        "<enter>","<wait10>",
        "<enter>","<wait10>","<wait10>",
        "passwd {{user `username`}}","<enter>","<wait>",
        "{{user `password`}}","<enter>","<wait>",
        "{{user `password`}}","<enter>","<wait>",
        "{{user `password`}}","<enter>","<wait>"
      ],
      "boot_wait": "5s",
      "type": "virtualbox-iso",
      "vm_name": "{{user `vm_name`}}",
      "disk_size": "{{user `disksize`}}",
      "hard_drive_interface": "sata",
      "iso_interface": "sata",
      "hard_drive_nonrotational": "true",
      "guest_additions_mode": "disable",
      "guest_os_type": "{{user `guest_os_type`}}",
      "headless": "{{user `headless`}}",
      "ssh_pty": "true",
      "iso_checksum": "sha256:{{user `sysrescuecd_checksum`}}",
      "iso_url": "{{user `sysrescuecd_url`}}",
      "shutdown_command": "shutdown -hP now",
      "ssh_username": "{{user `username`}}",
      "ssh_password": "{{user `password`}}",
      "ssh_wait_timeout": "30s",
      "vboxmanage":[
        ["modifyvm","{{.Name}}","--memory","{{user `memory`}}"],
        ["modifyvm","{{.Name}}","--cpus","{{user `cpus`}}"],
        ["modifyvm","{{.Name}}","--nictype1","virtio"],
        ["modifyvm","{{.Name}}","--audio","none"],
        ["modifyvm","{{.Name}}","--usb","off"],
        ["modifyvm","{{.Name}}","--chipset","ich9"],
        ["modifyvm","{{.Name}}","--rtcuseutc","on"],
        ["modifyvm","{{.Name}}","--vram","12"],
        ["modifyvm","{{.Name}}","--vrde","off"],
        ["modifyvm","{{.Name}}","--hpet","on"],
        ["modifyvm","{{.Name}}","--hwvirtex","on"],
        ["modifyvm","{{.Name}}","--vtxvpid","on"],
        ["modifyvm","{{.Name}}","--largepages","on"],
        ["modifyvm","{{.Name}}","--graphicscontroller","vmsvga"],
        ["modifyvm","{{.Name}}","--accelerate3d","off"]
      ]
  }],
  "description": "{{user `box_description`}}",
  "post-processors": [{
      "type": "checksum",
      "checksum_types": [ "sha1" ],
      "output": "packer_{{.BuildName}}_{{.ChecksumType}}.checksum"
    },{
      "output": "{{user `output_file`}}",
      "type": "vagrant"
  }],
  "provisioners": [{
      "destination": "/tmp",
      "source": "scripts",
      "type": "file"
    },
    {
      "type": "shell",
      "script": "packer/provision.sh",
      "environment_vars": [
          "scripts=/tmp",
          "BUILD_RUN=true",
          "BUILD_BOX_NAME={{user `vm_name`}}",
          "BUILD_BOX_USERNAME={{user `vm_username`}}",
          "BUILD_BOX_VERSION={{user `version`}}",
          "BUILD_MAKEOPTS={{user `makeopts`}}",
          "BUILD_TIMESTAMP={{user `timestamp`}}",
          "BUILD_TIMEZONE={{user `timezone`}}",
          "BUILD_STAGE3_FILE={{user `stage3_file`}}",
          "BUILD_STAGE3_URL={{user `stage3_url`}}",
          "BUILD_STAGE3_PATH={{user `stage3_path`}}",
          "BUILD_GUEST_ADDITIONS={{user `guest_additions`}}",
          "BUILD_REBUILD_SYSTEM={{user `rebuild_system`}}",
          "BUILD_CUSTOM_OVERLAY={{user `custom_overlay`}}",
          "BUILD_CUSTOM_OVERLAY_NAME={{user `custom_overlay_name`}}",
          "BUILD_CUSTOM_OVERLAY_URL={{user `custom_overlay_url`}}",
          "BUILD_CUSTOM_OVERLAY_BRANCH={{user `custom_overlay_branch`}}"
      ],
      "expect_disconnect": false
  }],
  "variables": {
    "sysrescuecd_url": "{{env `BUILD_SYSRESCUECD_FILE`}}",
    "sysrescuecd_checksum": "{{env `BUILD_SYSRESCUECD_REMOTE_HASH`}}",
    "stage3_file": "{{env `BUILD_STAGE3_FILE`}}",
    "stage3_url": "{{env `BUILD_STAGE3_URL`}}",
    "stage3_path": "{{env `BUILD_STAGE3_PATH`}}",
    "output_file": "{{env `BUILD_OUTPUT_FILE_TEMP`}}",
    "box_description": "{{env `BUILD_BOX_DESCRIPTION`}}",
    "guest_os_type": "{{env `BUILD_GUEST_TYPE`}}",
    "vm_name": "{{env `BUILD_BOX_NAME`}}",
    "vm_username": "{{env `BUILD_BOX_USERNAME`}}",
    "version": "{{env `BUILD_BOX_VERSION`}}",
    "makeopts": "{{env `BUILD_MAKEOPTS`}}",
    "timestamp": "{{env `BUILD_TIMESTAMP`}}",
    "timezone": "{{env `BUILD_TIMEZONE`}}",
    "cpus": "{{env `BUILD_CPUS`}}",
    "memory": "{{env `BUILD_MEMORY`}}",
    "disksize": "{{env `BUILD_GUEST_DISKSIZE`}}",
    "guest_additions": "{{env `BUILD_GUEST_ADDITIONS`}}",
    "rebuild_system": "{{env `BUILD_REBUILD_SYSTEM`}}",
    "custom_overlay": "{{env `BUILD_CUSTOM_OVERLAY`}}",
    "custom_overlay_name": "{{env `BUILD_CUSTOM_OVERLAY_NAME`}}",
    "custom_overlay_url": "{{env `BUILD_CUSTOM_OVERLAY_URL`}}",
    "custom_overlay_branch": "{{env `BUILD_CUSTOM_OVERLAY_BRANCH`}}",
    "headless": "true",
    "username": "root",
    "password": "toor"
  }
}
